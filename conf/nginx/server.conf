# Set rate limit zone 'flood'
limit_req_zone $binary_remote_addr zone=flood:15m rate=3r/s;


server {
	##
	# THE BASICS
	##

	listen 80 default_server;

	root /bedrock/web;
	index index.php;

	client_max_body_size 250m;

	# Check and enable RealIP
	include /etc/nginx/real_ip.conf;

	if ($http_x_forwarded_proto = "https") {
		set $use_ssl "on";
	}

	location / {
		# First attempt to serve request as file, then
		# as a directory, then pass the request to
		# WordPress's front controller.
		try_files $uri $uri/ /index.php?$args;
	}

	##
	# SECURITY
	##

	server_tokens off;

	# Frontend IP whitelist
	include /etc/nginx/whitelist-frontend.conf;

	# deny access to dotfiles
	# this will deny access to .git, .htaccess, .env, and other sensitive files
	location ~ /\. {
		deny all;
	}

	# Deny access to any files with a .php extension in the uploads directory
	# Works in sub-directory installs and also in multisite network
	# Keep logging the requests to parse later (or to pass to firewall utilities such as fail2ban)
	location ~* /(?:uploads|files)/.*\.php$ {
		deny all;
	}

	##
	# PHP
	##

	# pass PHP requests to php-fpm
	location ~ \.php$ {
		include /etc/nginx/php-fpm.conf;
	}

	# WordPress admin IP whitelist
	location = /wp/wp-login.php {
		limit_req zone=flood nodelay;

		include /etc/nginx/whitelist.conf;
		include /etc/nginx/php-fpm.conf;
	}

	##
	# GZIP COMPRESSION
	##

	gzip on;
	gzip_disable "msie6";

	gzip_vary on;
	gzip_proxied any;
	gzip_comp_level 6;
	gzip_buffers 16 8k;
	gzip_http_version 1.1;
	gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
}
